<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>fabric-layers React Demo</title>
    <style>
        body { margin: 0; padding: 20px; font-family: Arial, sans-serif; }
        .canvas-container { 
            border: 1px solid #ccc; 
            margin: 20px 0; 
            width: 800px; 
            height: 600px; 
            background: #f8f9fa; 
        }
        .controls { 
            margin: 20px 0; 
            padding: 15px; 
            background: #f5f5f5; 
            border-radius: 4px; 
            max-width: 800px;
        }
        button { 
            padding: 8px 16px; 
            margin-right: 10px; 
            cursor: pointer; 
        }
        input[type="number"] {
            width: 70px;
        }
        label {
            margin-right: 15px;
            white-space: nowrap;
        }
        .coords {
            font-family: monospace;
            margin-left: 20px;
            display: inline-block;
            min-width: 150px;
        }
    </style>
</head>
<body>
    <div id="root"></div>

    <!-- React -->
    <script src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    <!-- Babel for JSX -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <!-- Fabric -->
    <script src="https://cdn.jsdelivr.net/npm/fabric-pure-browser@5.1.0/dist/fabric.min.js"></script>
    <!-- Our library -->
    <script src="../dist/index.umd.js"></script>

    <script type="text/babel">
        const { useState, useEffect, useRef } = React;
        const { FabricMap } = FabricLayersReact;
        
        function Demo() {
            const [coordinates, setCoordinates] = useState({ x: 0, y: 0 });
            const [zoom, setZoom] = useState(1);
            const [minZoom, setMinZoom] = useState(0.05);
            const [maxZoom, setMaxZoom] = useState(20);
            const [pinOrigin, setPinOrigin] = useState('NONE');
            const [pinMargin, setPinMargin] = useState(10);
            const [zoomOverMouse, setZoomOverMouse] = useState(true);
            const mapRef = useRef(null);

            const handleMapReady = (map) => {
                mapRef.current = map;
                
                // Set up event listeners
                map.on('mouse:move', (e) => {
                    if (e?.pointer) {
                        setCoordinates({
                            x: e.pointer.x.toFixed(1),
                            y: e.pointer.y.toFixed(1)
                        });
                    }
                });

                map.on('zoom', () => {
                    setZoom(map.zoom);
                });

                // Enable grid if not already enabled
                if (!map.grid && typeof map.addGrid === 'function') {
                    map.addGrid();
                }

                // Set initial zoom limits
                updateZoomLimits();
            };

            const updateZoomLimits = () => {
                if (!mapRef.current) return;
                
                let min = parseFloat(minZoom);
                let max = parseFloat(maxZoom);
                
                if (isNaN(min) || min <= 0) min = 0.01;
                if (isNaN(max) || max <= min) max = min + 0.01;
                
                // Update refs
                mapRef.current.minZoom = min;
                mapRef.current.maxZoom = max;
                
                // Clamp current zoom if needed
                const currentZoom = mapRef.current.zoom || 1;
                if (currentZoom < min) mapRef.current.setZoom(min);
                if (currentZoom > max) mapRef.current.setZoom(max);
                
                // Update state
                setMinZoom(min);
                setMaxZoom(max);
                setZoom(mapRef.current.zoom);
            };

            const handleResetView = () => {
                if (mapRef.current && typeof mapRef.current.reset === 'function') {
                    mapRef.current.reset();
                }
            };

            // Update pin origin when it changes
            useEffect(() => {
                if (mapRef.current) {
                    mapRef.current.setOriginPin(pinOrigin);
                }
            }, [pinOrigin]);

            // Update pin margin when it changes
            useEffect(() => {
                if (mapRef.current) {
                    mapRef.current.setPinMargin(pinMargin);
                }
            }, [pinMargin]);

            // Update zoom over mouse setting
            useEffect(() => {
                if (mapRef.current) {
                    mapRef.current.setZoomOverMouse(zoomOverMouse);
                }
            }, [zoomOverMouse]);

            // Update zoom limits when they change
            useEffect(() => {
                updateZoomLimits();
            }, [minZoom, maxZoom]);

            return (
                <div>
                    <h1>fabric-layers React Demo</h1>
                    <div className="controls">
                        <label>
                            Min Zoom: 
                            <input 
                                type="number" 
                                step="0.01" 
                                value={minZoom}
                                onChange={(e) => setMinZoom(parseFloat(e.target.value) || 0.01)}
                            />
                        </label>
                        <label>
                            Max Zoom: 
                            <input 
                                type="number" 
                                step="0.01" 
                                value={maxZoom}
                                onChange={(e) => setMaxZoom(parseFloat(e.target.value) || 20)}
                            />
                        </label>
                        <button onClick={handleResetView}>Reset View</button>
                        <br /><br />
                        <label>
                            Pin Origin: 
                            <select 
                                value={pinOrigin}
                                onChange={(e) => 
                                    setPinOrigin(e.target.value)
                                }
                                style={{ width: '100px', marginRight: '10px' }}
                            >
                                <option value="NONE">None</option>
                                <option value="TOP_LEFT">Top Left</option>
                                <option value="TOP_RIGHT">Top Right</option>
                                <option value="BOTTOM_LEFT">Bottom Left</option>
                                <option value="BOTTOM_RIGHT">Bottom Right</option>
                            </select>
                        </label>
                        <label>
                            Pin Margin: 
                            <input 
                                type="number" 
                                step="1" 
                                value={pinMargin}
                                onChange={(e) => setPinMargin(parseInt(e.target.value) || 0)}
                            />
                        </label>
                        <label>
                            <input 
                                type="checkbox" 
                                checked={zoomOverMouse}
                                onChange={(e) => setZoomOverMouse(e.target.checked)}
                            />
                            Zoom Follows Mouse
                        </label>
                        <br /><br />
                        <span className="coords">X: {coordinates.x}, Y: {coordinates.y}</span>
                        <span className="coords">Zoom: {zoom.toFixed(2)}x</span>
                    </div>
                    <div className="canvas-container">
                        <FabricMap 
                            width={800} 
                            height={600} 
                            onReady={handleMapReady}
                            showGrid={true}
                            mode="GRAB"
                        />
                    </div>
                </div>
            );
        }

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<Demo />);
    </script>
</body>
</html>
